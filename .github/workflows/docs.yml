# SPDX-FileCopyrightText: 2024 The Forkbomb Company
#
# SPDX-License-Identifier: AGPL-3.0-or-later

name: 📖 Docs

on:
  push:
    branches:
      - main
    paths: [ "docs/**" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  packageManager:
    name: 🔍 Get pnpm version to use
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v4
      - name: 🔍 Get pnpm version from pacakgeManager field
        id: ver
        run: |
          echo "version=$( jq -r '.packageManager' package.json | cut -d@ -f2 )" >> $GITHUB_OUTPUT

  build_docs:
    name: 🏗️ Build documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: 🛠️ Prepare pnpm workspace
        uses: dyne/pnpm@main
        with:
          node-version: 20
          pnpm-version: ${{ needs.packageManager.outputs.version }}
      - name: 📖 Setup Pages
        uses: actions/configure-pages@v5
      - name: 🏗️ update sentences tabled and build the docs
        run: pnpm run docs:build
      - name: ⏫ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  deploy_docs:
    name: 🚀 Deploy documentation
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build_docs
    runs-on: ubuntu-latest
    steps:
      - name: 📡 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
